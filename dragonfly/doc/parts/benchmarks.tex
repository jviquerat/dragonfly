%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Benchmarks}
\label{section:benchmarks}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\section{Reference meshes}
%\label{section:bench_meshes}
%
%This section contains reference meshes used in benchmarks. 3D meshes are presented in table \ref{table:3D_bench_meshes}: the Buddha, Falcon and Earth meshes are only surfacic meshes, while the other are volumic ones. 2D meshes are shown in table \ref{table:2D_bench_meshes}.
%
%%%%%%%%%%%%%
%%%%%%%%%%%%%
%\begin{table}
%    \footnotesize
%    \caption{\textbf{3D benchmark meshes}}
%    \label{table:3D_bench_meshes}
%    \centering
%    \begin{tabular}{cc}
%        \toprule
%        													&												\\
%        	\fbox{\includegraphics[height=5cm]{img/buddha_full.jpg}} 		& \fbox{\includegraphics[height=5cm]{img/gear.jpg}} 			\\
%	Happy Buddha 										& Gear											\\
%	Stanford scanning repository \cite{stanford_scanning} 		& Vizir4 webpage \cite{vizir4}							\\
%	\num{543652} vertices								& \num{285809} vertices	 							\\
%	\num{1087716} triangles								& \num{248052} hexahedra 							\\
%													&												\\
%	\fbox{\includegraphics[height=5cm]{img/cylinder.jpg}} 		& \fbox{\includegraphics[height=5cm]{img/falcon_zoom.jpg}} 	\\
%	Double cylinder 									& Falcon											\\
%	\textsc{CFL} team 							 		& Vizir4 webpage \cite{vizir4}							\\
%	\num{62981} vertices								& \num{319942} vertices	 							\\
%	\num{357423} tetrahedra								& \num{152276} triangles	 							\\
%													&												\\
%        	\fbox{\includegraphics[height=5cm]{img/sphere.jpg}} 			& \fbox{\includegraphics[height=5cm]{img/earth.jpg}} 		\\
%	Sphere	 										& Earth											\\
%	\textsc{CFL} team									& Shingle project \cite{shingle}							\\
%	\num{4099} vertices									& \num{229810} vertices	 							\\
%	\num{20322} tetrahedra								& \num{429703} triangles	 							\\
%													&												\\\bottomrule
%    \end{tabular}
%\end{table}
%%%%%%%%%%%%%
%%%%%%%%%%%%%
%
%%%%%%%%%%%%%
%%%%%%%%%%%%%
%\begin{table}
%    \footnotesize
%    \caption{\textbf{2D benchmark meshes}}
%    \label{table:2D_bench_meshes}
%    \centering
%    \begin{tabular}{cc}
%        \toprule
%        													&												\\
%        	\fbox{\includegraphics[height=5cm]{img/shape.jpg}} 			& \fbox{\includegraphics[height=5cm]{img/random.jpg}} 		\\
%	Domain with hole									& Random shape									\\
%	\textsc{CFL} team							 		& \textsc{CFL} team									\\
%	\num{5805} vertices									& \num{8735} vertices	 							\\
%	\num{11187} triangles								& \num{16904} triangles	 							\\
%													&												\\
%        	\fbox{\includegraphics[height=5cm]{img/disk_holes.jpg}} 		& \fbox{\includegraphics[height=5cm]{img/uk.jpg}} 			\\
%	Disk with holes		 								& UK map											\\
%	\textsc{CFL} team									& Shingle project \cite{shingle}							\\
%	\num{1552} vertices									& \num{55123} vertices	 							\\
%	\num{2892} triangles									& \num{104260} triangles	 							\\
%													&												\\\bottomrule
%    \end{tabular}
%\end{table}
%%%%%%%%%%%%%
%%%%%%%%%%%%%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\section{\codeinline{kd_tree}}
%
%In this section, the performance of the closest neighbor search of the \codeinline{kd_tree} structure is assessed against linear search on 2D and 3D meshes of variable sizes. A set of regular square and cube meshes generated on-the-fly is used (see section \ref{section:cube_mesh}), along with several reference meshes, presented in section \ref{section:bench_meshes}. All the tests were performed in serial on a node holding two AMD Epyc Roma 7502 (32 cores each, 2.5 GHz) and 256 Go of RAM. The time to build the \codeinline{kd_tree} structure is presented in figure \ref{fig:bench_build_kd_tree}, while a search time comparison for a fixed amount of points is shown in figure \ref{fig:bench_search_kd_tree}. The speedup for the \codeinline{kd_tree} search over the linear search is presented in figure \ref{fig:bench_speedup_kd_tree}.
%
%As can be observed, the building time scales almost perfectly with the number of vertices present in the mesh, regardless of the geometric dimension or the geometrical complexity of the latter. Contrarily, variations can be observed for nearest neighbor search, depending mostly on the complexity of the domain and on the regularity of the discretization, with best performances being obtained for regular square and cube meshes. Yet, even in the worst configurations, speedups against linear search remain very acceptable, ranging from 3 (disk with holes) to 300 (falcon) on the considered meshes. On regular square and cube meshes, speedups can reach values as high as 3000 on very large meshes, although this is beyond the range of number of vertices found in common applications (10k to 1M). Similarly, speedups slightly below one are obtained for very small meshes (containing 100 vertices or less), which do not represent either the regular application range of the structure.
%
%%%%%%%%%%%%%
%%%%%%%%%%%%%
%\begin{figure}
%\centering
%%%%%%%%%%%%%
%	\begin{tikzpicture}[	trim axis left, trim axis right, font=\small,
%					upper/.style={	name path=upper, smooth, draw=none},
%					lower/.style={	name path=lower, smooth, draw=none},
%					mean/.style={	very thick, smooth,mark size=4pt,mark=*}]
%	\begin{loglogaxis}[	xmin=100, xmax=10000000, scale=0.95, 
%					legend cell align=left, legend pos=outer north east, legend style={font=\scriptsize},
%					grid=major, xlabel=\# of vertices in mesh, ylabel=generation time (s.)]
%
%		\addplot[orange1, mean, forget plot] table[x index=1,y index=2] {fig/benchmarks/bench_2D.csv}; % squares
%		\addplot[teal, mean, forget plot, mark=square*] coordinates {(1552,0.000566)}; % disk with holes
%		\addplot[olive, mean, forget plot, mark=square*] coordinates {(5805,0.00285)}; % domain with hole
%		\addplot[brown, mean, forget plot, mark=square*] coordinates {(8735,0.00439)}; % random shape
%		\addplot[green!50!black, mean, forget plot, mark=square*] coordinates {(55123,0.0411)}; % uk
%		
%		\addplot[blue1, mean, forget plot] table[x index=1,y index=2] {fig/benchmarks/bench_3D.csv}; % cubes
%		\addplot[red, mean, forget plot, mark=square*] coordinates {(543652,0.688)}; % buddha
%		\addplot[gray1, mean, forget plot, mark=square*] coordinates {(319942,0.335)}; % falcon
%		\addplot[bluegray1, mean, forget plot, mark=square*] coordinates {(285809,0.291)}; % gear
%		\addplot[blue, mean, forget plot, mark=square*] coordinates {(229810,0.208)}; % earth
%		\addplot[magenta, mean, forget plot, mark=square*] coordinates {(62981,0.0484)}; % cylinder
%		\addplot[purple, mean, forget plot, mark=square*] coordinates {(4099,0.00215)}; % sphere
%		
%		% legends
%		\addlegendimage{orange1, mean}
%		\addlegendentry{squares}
%		\addlegendimage{teal, mean, mark=square*}
%		\addlegendentry{disk}
%		\addlegendimage{olive, mean, mark=square*}
%		\addlegendentry{domain}
%		\addlegendimage{brown, mean, mark=square*}
%		\addlegendentry{shape}
%		\addlegendimage{green!50!black, mean, mark=square*}
%		\addlegendentry{UK map}
%		
%		\addlegendimage{blue1, mean}
%		\addlegendentry{cubes}
%		\addlegendimage{red, mean, mark=square*}
%		\addlegendentry{buddha}
%		\addlegendimage{gray1, mean, mark=square*}
%		\addlegendentry{falcon}
%		\addlegendimage{bluegray1, mean, mark=square*}
%		\addlegendentry{gear}
%		\addlegendimage{blue, mean, mark=square*}
%		\addlegendentry{earth}
%		\addlegendimage{magenta, mean, mark=square*}
%		\addlegendentry{cylinder}
%		\addlegendimage{purple, mean, mark=square*}
%		\addlegendentry{sphere}
%			
%	\end{loglogaxis}
%\end{tikzpicture}
%%%%%%%%%%%%%
%\caption{\textbf{Time required for the \codeinline{kd_tree} generation} on various 2D and 3D meshes.}
%\label{fig:bench_build_kd_tree}
%\end{figure}
%%%%%%%%%%%%%
%%%%%%%%%%%%%
%
%%%%%%%%%%%%%
%%%%%%%%%%%%%
%\begin{figure}
%\centering
%%%%%%%%%%%%%
%	\begin{tikzpicture}[	trim axis left, trim axis right, font=\small,
%					mean/.style={very thick, smooth, mark size=4pt, mark=*}]
%	\begin{loglogaxis}[	xmin=100, xmax=10000000, scale=1, 
%					legend cell align=left, legend pos=outer north east, legend style={font=\scriptsize},
%					grid=major, xlabel=\# of vertices in mesh, ylabel=search time (s.)]
%					
%		% kd-tree on squares
%		\addplot[orange1, mean, mark=square*, forget plot] 	table[x index=1,y index=3] {fig/benchmarks/bench_2D.csv}; 
%		
%		% linear search on squares
%		\addplot[orange1, mean, mark=*, forget plot] table[x index=1,y index=6] {fig/benchmarks/bench_2D.csv}; 
%					
%		% disk with holes
%		\addplot[teal, mean, mark=square*, forget plot] coordinates {(1552,0.00863)}; 
%		\addplot[teal, mean, mark=*, forget plot] coordinates {(1552,0.0255)};
%		
%		% domain with hole
%		\addplot[olive, mean, mark=square*, forget plot] coordinates {(5805,0.0318)}; 
%		\addplot[olive, mean, mark=*, forget plot] coordinates {(5805,0.0967)};
%		
%		% random shape
%		\addplot[brown, mean, mark=square*, forget plot] coordinates {(8735,0.0312)}; 
%		\addplot[brown, mean, mark=*, forget plot] coordinates {(8735,0.141)};
%		
%		% UK map
%		\addplot[green!50!black, mean, mark=square*, forget plot] coordinates {(55123,0.0781)}; 
%		\addplot[green!50!black, mean, mark=*, forget plot] coordinates {(55123,0.615)};
%
%		% kd-tree on cubes
%		\addplot[blue1, mean, mark=square*, forget plot] 	table[x index=1,y index=3] {fig/benchmarks/bench_3D.csv}; 
%		
%		% linear search on cubes
%		\addplot[blue1, mean, mark=*, forget plot] 	table[x index=1,y index=6] {fig/benchmarks/bench_3D.csv}; 
%		
%		% buddha
%		\addplot[red, mean, mark=square*, forget plot] coordinates {(543652,0.708)}; 
%		\addplot[red, mean, mark=*, forget plot] coordinates {(543652,10.9)};
%		
%		% falcon
%		\addplot[gray1, mean, mark=square*, forget plot] coordinates {(319942,0.0181)}; 
%		\addplot[gray1, mean, mark=*, forget plot] coordinates {(319942,5.145)}; 
%		
%		% gear
%		\addplot[bluegray1, mean, mark=square*, forget plot] coordinates {(285809,0.0912)}; 
%		\addplot[bluegray1, mean, mark=*, forget plot] coordinates {(285809,4.598)}; 
%		
%		% cylinder
%		\addplot[magenta, mean, mark=square*, forget plot] coordinates {(62981,0.0124)}; 
%		\addplot[magenta, mean, mark=*, forget plot] coordinates {(62981,1.02)}; 
%		
%		% sphere
%		\addplot[purple, mean, mark=square*, forget plot] coordinates {(4099,0.00508)}; 
%		\addplot[purple, mean, mark=*, forget plot] coordinates {(4099,0.066)}; 
%		
%		% earth
%		\addplot[blue, mean, mark=square*, forget plot] coordinates {(229810,0.245)}; 
%		\addplot[blue, mean, mark=*, forget plot] coordinates {(229810,3.70)}; 
%		
%		% legends
%		\addlegendimage{black, mean, mark=square*, only marks}
%		\addlegendentry{kd-tree search}
%		\addlegendimage{black, mean, mark=*, only marks}
%		\addlegendentry{linear search}
%		
%		\addlegendimage{orange1, mean, no markers}
%		\addlegendentry{squares}
%		\addlegendimage{teal, mean, no markers}
%		\addlegendentry{disk}
%		\addlegendimage{olive, mean, no markers}
%		\addlegendentry{domain}
%		\addlegendimage{brown, mean, no markers}
%		\addlegendentry{shape}
%		\addlegendimage{green!50!black, mean, no markers}
%		\addlegendentry{UK map}
%		
%		\addlegendimage{blue1, mean, no markers}
%		\addlegendentry{cubes}
%		\addlegendimage{red, mean, no markers}
%		\addlegendentry{buddha}
%		\addlegendimage{gray1, mean, no markers}
%		\addlegendentry{falcon}
%		\addlegendimage{bluegray1, mean, no markers}
%		\addlegendentry{gear}
%		\addlegendimage{blue, mean, no markers}
%		\addlegendentry{earth}
%		\addlegendimage{magenta, mean, no markers}
%		\addlegendentry{cylinder}
%		\addlegendimage{purple, mean, no markers}
%		\addlegendentry{sphere}
%			
%	\end{loglogaxis}
%\end{tikzpicture}
%%%%%%%%%%%%%
%\caption{\textbf{\codeinline{kd_tree} benchmark against linear search on various 2D and 3D meshes}, for a research of \num{10000} random points. Selected meshes include regular square and cube meshes, as well as other reference meshes.}
%\label{fig:bench_search_kd_tree}
%\end{figure}
%%%%%%%%%%%%%
%%%%%%%%%%%%%
%
%%%%%%%%%%%%%
%%%%%%%%%%%%%
%\begin{figure}
%\centering
%%%%%%%%%%%%%
%	\begin{tikzpicture}[	trim axis left, trim axis right, font=\small,
%					upper/.style={	name path=upper, smooth, draw=none},
%					lower/.style={	name path=lower, smooth, draw=none},
%					mean/.style={	very thick, smooth,mark size=4pt,mark=*}]
%	\begin{loglogaxis}[	xmin=100, xmax=10000000, scale=0.95, 
%					legend cell align=left, legend pos=outer north east, legend style={font=\scriptsize},
%					grid=major, xlabel=\# of vertices in mesh, ylabel=speedup]
%
%		\addplot[black, mean, forget plot, dash pattern=on 2pt] coordinates {(1,1) (1e8,1)};
%		\addplot[orange1, mean, forget plot] table[x index=1,y index=9] {fig/benchmarks/bench_2D.csv}; % squares
%		\addplot[teal, mean, forget plot, mark=square*] coordinates {(1552,2.95)}; % disk with holes
%		\addplot[olive, mean, forget plot, mark=square*] coordinates {(5805,3.04)}; % domain with hole
%		\addplot[brown, mean, forget plot, mark=square*] coordinates {(8735,4.52)}; % random shape
%		\addplot[green!50!black, mean, forget plot, mark=square*] coordinates {(55123,7.87)}; % uk
%		
%		\addplot[blue1, mean, forget plot] table[x index=1,y index=9] {fig/benchmarks/bench_3D.csv}; % cubes
%		\addplot[red, mean, forget plot, mark=square*] coordinates {(543652,15.39)}; % buddha
%		\addplot[gray1, mean, forget plot, mark=square*] coordinates {(319942,284)}; % falcon
%		\addplot[bluegray1, mean, forget plot, mark=square*] coordinates {(285809,50.4)}; % gear
%		\addplot[blue, mean, forget plot, mark=square*] coordinates {(229810,15.1)}; % earth
%		\addplot[magenta, mean, forget plot, mark=square*] coordinates {(62981,82.2)}; % cylinder
%		\addplot[purple, mean, forget plot, mark=square*] coordinates {(4099,13.0)}; % sphere
%		
%		% legends
%		\addlegendimage{orange1, mean}
%		\addlegendentry{squares}
%		\addlegendimage{teal, mean, mark=square*}
%		\addlegendentry{disk}
%		\addlegendimage{olive, mean, mark=square*}
%		\addlegendentry{domain}
%		\addlegendimage{brown, mean, mark=square*}
%		\addlegendentry{shape}
%		\addlegendimage{green!50!black, mean, mark=square*}
%		\addlegendentry{UK map}
%		
%		\addlegendimage{blue1, mean}
%		\addlegendentry{cubes}
%		\addlegendimage{red, mean, mark=square*}
%		\addlegendentry{buddha}
%		\addlegendimage{gray1, mean, mark=square*}
%		\addlegendentry{falcon}
%		\addlegendimage{bluegray1, mean, mark=square*}
%		\addlegendentry{gear}
%		\addlegendimage{blue, mean, mark=square*}
%		\addlegendentry{earth}
%		\addlegendimage{magenta, mean, mark=square*}
%		\addlegendentry{cylinder}
%		\addlegendimage{purple, mean, mark=square*}
%		\addlegendentry{sphere}
%			
%	\end{loglogaxis}
%\end{tikzpicture}
%%%%%%%%%%%%%
%\caption{\textbf{Speedup of \codeinline{kd_tree} against linear search for nearest neighbor search}.}
%\label{fig:bench_speedup_kd_tree}
%\end{figure}
%%%%%%%%%%%%%
%%%%%%%%%%%%%